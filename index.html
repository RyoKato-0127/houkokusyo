<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>訪問看護報告書作成ツール v9.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f3f4f6; }
    .input-field { width: 100%; border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.75rem; margin-top: 0.25rem; font-size: 1rem; }
    .btn-primary { background-color: #2563eb; color: white; font-weight: bold; padding: 0.75rem; border-radius: 0.5rem; width: 100%; transition: background-color 0.2s; }
    .btn-secondary { background-color: #111827; color: white; font-weight: bold; padding: 0.75rem; border-radius: 0.5rem; width: 100%; }
    .btn-outline { background-color: white; border: 1px solid #d1d5db; color: #111827; font-weight: bold; padding: 0.75rem; border-radius: 0.5rem; width: 100%; }
    .btn-primary:disabled, .btn-secondary:disabled, .btn-outline:disabled { background-color: #9ca3af; cursor: not-allowed; border-color: #9ca3af; color: white; }
    .card { background-color: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
  </style>
</head>
<body class="p-4 max-w-2xl mx-auto pb-20">

  <div class="flex justify-between items-center mb-6 relative">
    <div class="text-center w-full">
      <h1 class="text-xl font-bold text-gray-800">
        <i class="fas fa-file-medical text-blue-600 mr-2"></i>訪問看護報告書作成
      </h1>
      <p class="text-xs text-gray-500">月次まとめ（プレビュー→修正→保存） v9.0</p>
    </div>
    <button onclick="toggleSettings()" class="absolute right-0 text-gray-500 hover:text-gray-700 p-2">
      <i class="fas fa-cog text-xl"></i>
    </button>
  </div>

  <div id="statusMessage" class="hidden mb-4 p-4 rounded-md text-sm font-bold whitespace-pre-wrap"></div>

  <div id="settingsPanel" class="hidden mb-4 bg-gray-100 p-4 rounded-lg border border-gray-300">
    <label class="block text-sm font-bold text-gray-700 mb-2">Google Apps Script URL</label>
    <input type="text" id="gasUrlInput" class="input-field mb-2" placeholder="https://script.google.com/macros/s/xxxx/exec">
    <div class="text-xs text-gray-500 mb-2">※発行されたURL（/exec）を入力</div>
    <button onclick="saveSettings()" class="btn-secondary">保存して閉じる</button>
  </div>

  <div class="card">
    <h2 class="text-sm font-bold text-gray-600 mb-3"><i class="fas fa-user-circle mr-2"></i>基本情報</h2>
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-xs text-gray-500">報告月</label>
        <input type="month" id="reportMonth" class="input-field">
      </div>
      <div>
        <label class="block text-xs text-gray-500">患者氏名</label>
        <input type="text" id="patientName" class="input-field" placeholder="例：山田 太郎">
      </div>
      <div>
        <label class="block text-xs text-gray-500">作成者職種</label>
        <select id="staffType" class="input-field">
          <option value="看護師">看護師</option>
          <option value="理学療法士（PT）">理学療法士（PT）</option>
          <option value="作業療法士（OT）">作業療法士（OT）</option>
          <option value="言語聴覚士（ST）">言語聴覚士（ST）</option>
        </select>
      </div>
      <div>
        <label class="block text-xs text-gray-500">作成者氏名</label>
        <input type="text" id="staffName" class="input-field" placeholder="例：鈴木 花子">
      </div>
    </div>
  </div>

  <div class="card">
    <h2 class="text-sm font-bold text-gray-600 mb-3"><i class="fas fa-edit mr-2"></i>1か月分の記録（貼り付け）</h2>
    <textarea id="rawRecords" class="input-field h-44" placeholder="1か月分をそのまま貼ってください（複数日分OK）"></textarea>
    <button onclick="document.getElementById('rawRecords').value=''" class="text-xs text-gray-400 mt-2 hover:text-red-500">
      <i class="fas fa-trash-alt mr-1"></i>クリア
    </button>
  </div>

  <button id="generateBtn" onclick="generatePreview()" class="btn-primary mb-4 shadow-lg">
    <i class="fas fa-magic mr-2"></i>報告書を生成（プレビュー）
  </button>

  <div id="resultArea" class="hidden">
    <div class="card">
      <h3 class="font-bold text-gray-800 mb-2"><i class="fas fa-eye mr-2"></i>生成結果（編集OK）</h3>
      <textarea id="generatedOutput" class="w-full bg-white border border-gray-200 rounded p-3 h-64 text-sm leading-relaxed"></textarea>

      <div class="grid grid-cols-1 gap-2 mt-3">
        <button onclick="copyToClipboard()" class="btn-outline">
          <i class="far fa-copy mr-2"></i>コピー
        </button>
      </div>
    </div>

    <div class="card">
      <h3 class="font-bold text-gray-800 mb-2"><i class="fas fa-wrench mr-2"></i>修正（任意）</h3>
      <div class="text-xs text-gray-500 mb-2">例：もっと短く／家族向けに／リスクを先に／専門用語を減らす 等</div>
      <textarea id="revisionInstruction" class="input-field h-24" placeholder="修正したい内容を入力（空ならスキップ可）"></textarea>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3">
        <button id="reviseBtn" onclick="revisePreview()" class="btn-secondary">
          <i class="fas fa-rotate-left mr-2"></i>修正して再生成
        </button>
        <button id="saveBtn" onclick="saveToNotion()" class="btn-primary">
          <i class="fas fa-cloud-upload-alt mr-2"></i>OKなのでNotionに保存
        </button>
      </div>

      <div class="text-xs text-gray-500 mt-2">
        ※「Notionに保存」は、生成結果を確認してから押してください（編集した内容も保存されます）
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'GAS_URL_V9';

    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      document.getElementById('reportMonth').value = `${yyyy}-${mm}`;

      const savedUrl = localStorage.getItem(STORAGE_KEY);
      if (savedUrl) {
        document.getElementById('gasUrlInput').value = savedUrl;
      } else {
        document.getElementById('settingsPanel').classList.remove('hidden');
      }
    });

    function toggleSettings() {
      document.getElementById('settingsPanel').classList.toggle('hidden');
    }

    function saveSettings() {
      const url = document.getElementById('gasUrlInput').value.trim().replace(/[\u200B-\u200D\uFEFF]/g, '');
      if (!url) return alert('URLを入力してください');
      localStorage.setItem(STORAGE_KEY, url);
      document.getElementById('gasUrlInput').value = url;
      alert('設定を保存しました');
      toggleSettings();
    }

    function basePayload() {
      return {
        reportMonth: document.getElementById('reportMonth').value,
        patientName: document.getElementById('patientName').value,
        staffType: document.getElementById('staffType').value,
        staffName: document.getElementById('staffName').value,
        rawRecords: document.getElementById('rawRecords').value
      };
    }

    function setStatus(msg, type) {
      const statusDiv = document.getElementById('statusMessage');
      statusDiv.textContent = msg;
      statusDiv.className = `mb-4 p-4 rounded-md text-sm font-bold whitespace-pre-wrap block ${
        type === 'ok' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
      }`;
    }

    function setLoading(isLoading, targetBtnId, text) {
      const btn = document.getElementById(targetBtnId);
      btn.disabled = isLoading;
      btn.dataset.original = btn.dataset.original || btn.innerHTML;
      btn.innerHTML = isLoading ? `<span class="spinner"></span>${text}` : btn.dataset.original;
    }

    async function postToGAS(payload) {
      const gasUrl = localStorage.getItem(STORAGE_KEY);
      if (!gasUrl) {
        toggleSettings();
        throw new Error('GASのURLが未設定です');
      }

      // CORS回避：text/plain
      const response = await fetch(gasUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
        redirect: 'follow'
      });

      // 失敗時に本文を読み、原因表示できるようにする
      const text = await response.text();
      let data;
      try { data = JSON.parse(text); } catch (e) { throw new Error(`JSON解析に失敗: ${text}`); }

      if (!response.ok) {
        throw new Error(data?.error || `HTTP ${response.status}`);
      }
      if (!data.success) {
        throw new Error(data.error || '不明なエラー');
      }
      return data;
    }

    async function generatePreview() {
      const payload = basePayload();
      if (!payload.rawRecords.trim()) return alert('1か月分の記録を入力してください');

      try {
        setLoading(true, 'generateBtn', '生成中...');
        document.getElementById('resultArea').classList.add('hidden');

        const data = await postToGAS({ ...payload, action: 'generate' });

        document.getElementById('generatedOutput').value = data.report;
        document.getElementById('revisionInstruction').value = '';
        document.getElementById('resultArea').classList.remove('hidden');
        setStatus('生成が完了しました。内容を確認し、必要なら修正してからNotion保存できます。', 'ok');
        document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });

      } catch (err) {
        console.error(err);
        setStatus('エラーが発生しました：\n' + err.message + '\n\n※GASのURL、デプロイ（全員）、APIキー設定を確認してください。', 'ng');
      } finally {
        setLoading(false, 'generateBtn', '');
      }
    }

    async function revisePreview() {
      const payload = basePayload();
      const previousDraft = document.getElementById('generatedOutput').value;
      const revisionInstruction = document.getElementById('revisionInstruction').value;

      if (!payload.rawRecords.trim()) return alert('1か月分の記録を入力してください');
      if (!previousDraft.trim()) return alert('先に「生成（プレビュー）」してください');
      if (!revisionInstruction.trim()) return alert('修正指示を入力してください（例：短く、家族向け、リスク優先など）');

      try {
        setLoading(true, 'reviseBtn', '修正中...');
        const data = await postToGAS({
          ...payload,
          action: 'generate',
          previousDraft,
          revisionInstruction
        });
        document.getElementById('generatedOutput').value = data.report;
        setStatus('修正反映が完了しました。OKならNotionに保存してください。', 'ok');

      } catch (err) {
        console.error(err);
        setStatus('エラーが発生しました：\n' + err.message, 'ng');
      } finally {
        setLoading(false, 'reviseBtn', '');
      }
    }

    async function saveToNotion() {
      const payload = basePayload();
      const reportText = document.getElementById('generatedOutput').value;
      if (!payload.rawRecords.trim()) return alert('1か月分の記録を入力してください');
      if (!reportText.trim()) return alert('保存する本文が空です');

      try {
        setLoading(true, 'saveBtn', 'Notion保存中...');
        await postToGAS({ ...payload, action: 'save', reportText });
        setStatus('Notionに保存しました！', 'ok');
      } catch (err) {
        console.error(err);
        setStatus('Notion保存でエラー：\n' + err.message + '\n\n※Notionのスクリプトプロパティ設定（キー/DB）も確認してください。', 'ng');
      } finally {
        setLoading(false, 'saveBtn', '');
      }
    }

    function copyToClipboard() {
      const el = document.getElementById("generatedOutput");
      el.select();
      document.execCommand("copy");
      alert("コピーしました！");
    }
  </script>
</body>
</html>
